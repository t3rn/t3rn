name: t0rn Rococo Release

on:
  push:
    branches:
    - development

env:
  PARACHAIN_NAME: t0rn
  RUST_BACKTRACE: full
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  release:
    runs-on: [self-hosted, rust]
    if: ${{ !contains(github.event.head_commit.message, 'build(release):') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          git_user_signingkey: true
          git_commit_gpgsign: true
          gpg_private_key: ${{ secrets.T3RN_CI_GPG_PRIVATE_KEY }}

      - name: Calculate semantic version
        id: version
        uses: t3rn/semantic-version@v6.0.2
        with:
          tag_prefix: "v"
          major_pattern: "/^(feat|refactor)!:/"
          minor_pattern: "/^(feat|refactor):/"
          version_format: "${major}.${minor}.${patch}-rc.${increment}"
          bump_each_commit: false
          search_commit_body: false
          user_format_type: "json"
          prerelease_name: "rc"

      - name: Cargo Release
        id: release
        run: |
          git config --global user.email "89840377+t3rn-ci@users.noreply.github.com"
          git config --global user.name "t3rn-ci"
          cargo release -c release.toml --execute --no-confirm -p t0rn-parachain-runtime -p t0rn-parachain-collator ${{ steps.version.outputs.version }} 

      - name: Push tag
        run: |
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}

      - name: Create Release
        id: release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          draft: false
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changes }}
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ steps.version.outputs.version }}

      - name: ‚öôÔ∏è Get nightly rust toolchain with wasm target
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2022-06-16
          target: wasm32-unknown-unknown
          components: rustfmt, clippy
          override: true

      - name: üè≠ Build circuit
        uses: actions-rs/cargo@v1
        continue-on-error: false
        with:
          command: build
          args: --manifest-path ./node/${{ env.PARACHAIN_NAME }}-parachain/Cargo.toml --locked --release

      - name: üì§ Upload collator binary
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.sha }}-${{ env.PARACHAIN_NAME }}-collator-release-artifacts
          path: ./target/release/${{ env.PARACHAIN_NAME }}-collator
          if-no-files-found: error
          retention-days: 1

      - name: ü´ß Build runtime WASM
        run: |
          ./scripts/build_wasm.sh ${{env.PARACHAIN_NAME}}

      - name: üì§ Upload runtime WASM binary
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.sha }}-${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm
          path: ./target/release/wbuild/${{ env.PARACHAIN_NAME }}-parachain-runtime/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm
          if-no-files-found: error
          retention-days: 1

      - name: üì§ Upload runtime WASM hash blake2_256
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.sha }}-${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm.blake2_256
          path: ./target/release/wbuild/${{ env.PARACHAIN_NAME }}-parachain-runtime/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm.blake2_256
          if-no-files-found: error
          retention-days: 1

      - name: üì• Download circuit collator
        uses: actions/download-artifact@v2
        with:
          name: ${{ github.sha }}-${{ env.PARACHAIN_NAME }}-collator-release-artifacts
          path: ./target/release/

      - name: üêã Login to the GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: üê≥ Build and publish the Docker image
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          tags: ghcr.io/t3rn/${{ env.PARACHAIN_NAME }}-collator:v${{ steps.version.outputs.version }}
          platforms: linux/amd64
          file: collator.${{ env.PARACHAIN_NAME }}.Dockerfile
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache

      - name: üé± Gzip circuit collator
        run: |
          gzip -c ./target/release/${{ env.PARACHAIN_NAME }}-collator \
          > ./target/release/${{ env.PARACHAIN_NAME }}-collator.gz

      - name: üñêüèæ Fingerprint the gball
        run: |
          sha256sum -b ./target/release/${{ env.PARACHAIN_NAME }}-collator.gz \
          | grep -oE '^[a-f0-9]+' \
          | tr -d '\n' \
          > ./target/release/${{ env.PARACHAIN_NAME }}-collator.gz.sha256sum

      - name: üñêüèæ Fingerprint the runtime WASM
        run: |
          sha256sum -b ./target/release/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm \
          | grep -oE '^[a-f0-9]+' \
          | tr -d '\n' \
          > ./target/release/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm.sha256sum

      - name: üçî Provide the circuit collator sha256sum as a release asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./target/release/${{ env.PARACHAIN_NAME }}-collator.gz.sha256sum
          asset_name: ${{ env.PARACHAIN_NAME }}-collator-v${{ steps.version.outputs.version }}-x86_64-unknown-linux-gnu.gz.sha256sum
          asset_content_type: text/plain

      - name: üì¶ Upload the circuit collator gball as a release asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./target/release/${{ env.PARACHAIN_NAME }}-collator.gz
          asset_name: ${{ env.PARACHAIN_NAME }}-collator-v${{ steps.version.outputs.version }}-x86_64-unknown-linux-gnu.gz
          asset_content_type: application/gzip

      - name: üçî Provide the runtime WASM sha256sum as a release asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./target/release/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm.sha256sum
          asset_name: ${{ env.PARACHAIN_NAME }}-parachain-runtime-v${{ steps.version.outputs.version }}.compact.compressed.wasm.sha256sum
          asset_content_type: text/plain

      - name: üçî Provide the runtime WASM blake2_256 as a release asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./target/release/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm.blake2_256
          asset_name: ${{ env.PARACHAIN_NAME }}-parachain-runtime-v${{ steps.version.outputs.version }}.compact.compressed.wasm.blake2_256
          asset_content_type: text/plain

      - name: üì¶ Upload the runtime WASM as a release asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./target/release/${{ env.PARACHAIN_NAME }}_parachain_runtime.compact.compressed.wasm
          asset_name: ${{ env.PARACHAIN_NAME }}-parachain-runtime-v${{ steps.version.outputs.version }}.compact.compressed.wasm
          asset_content_type: text/plain

  run-smoke-tests:
    runs-on: [self-hosted, rust]
    needs: release-on-github
    steps:
      - name: ‚òÅ Checkout git repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: ‚öôÔ∏è Get nightly rust toolchain with wasm target
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2022-06-16
          target: wasm32-unknown-unknown
          components: rustfmt, clippy
          override: true

      - name: üìº Run zombienet runtime upgrade test
        continue-on-error: false
        working-directory: tests/zombienet
        run: ./zombienet.sh upgrade t0rn