name: t0rn Runtime Upgrade

on:
  push:
    tags:
      # This is a GLOB not a regex. Don't add escape sequences to me
      - "v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+"

env:
  PARACHAIN_NAME: t0rn

jobs:
  runtime-upgrade-smoke-tests:
    runs-on: [self-hosted, rust]
    # This can only run when all release artificats are available
    concurrency: release
    steps:
      - name: ☁ Checkout git repo
        uses: actions/checkout@v3

      - name: ⚙️ Install rust toolchain defined in rust-toolchain.toml
        run: rustup show

      - name: 📼 Run zombienet runtime upgrade test
        continue-on-error: false
        working-directory: tests/zombienet
        run: ./zombienet.sh upgrade ${{ env.PARACHAIN_NAME }}

  runtime-upgrade:
    runs-on: self-hosted
    needs: runtime-upgrade-smoke-tests
    concurrency: runtime-upgrade
    steps:
      - name: ☁ Checkout git repo
        uses: actions/checkout@v3

      - name: Set variables 
        run: |
          echo "PUSHED_TAG=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV

          # PUSHED_TAG is not available yet in the env, so we need to use GITHUB_REF
          echo "WASM_RELEASE_ASSET=${{ env.PARACHAIN_NAME }}-parachain-runtime-${GITHUB_REF/refs\/tags\//}.compact.compressed.wasm" >> $GITHUB_ENV

      - name: 📥 Download runtime WASM
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: t3rn/t3rn
          version: "tags/${{ env.PUSHED_TAG }}"
          file: ${{ env.WASM_RELEASE_ASSET }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 📥 Download runtime WASM hash blake2_256
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: t3rn/t3rn
          version: "tags/${{ env.PUSHED_TAG }}"
          file: ${{ env.WASM_RELEASE_ASSET }}.blake2_256
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🚀 t0rn Runtime Upgrade Dry Run
        run: |
          # We want to run it in case it fails because just multiline env variable would obscure that
          ./scripts/upgrade-runtime-set-code.sh ${{ secrets.RUNTIME_UPGRADE_SEED }} ${{ env.PUSHED_TAG }} ${{ env.PARACHAIN_NAME }} --dry-run

          # This is a workaround for multiline env variable
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "RUNTIME_UPGRADE_OUTPUT<<$EOF" >> $GITHUB_ENV
          ./scripts/upgrade-runtime-set-code.sh ${{ secrets.RUNTIME_UPGRADE_SEED }} ${{ env.PUSHED_TAG }} ${{ env.PARACHAIN_NAME }} --dry-run >> $GITHUB_ENV
          echo "$EOF" >> $GITHUB_ENV          

      - name: 🚀 t0rn Runtime Upgrade
        run: |
          ./scripts/upgrade-runtime-set-code.sh ${{ secrets.RUNTIME_UPGRADE_SEED }} ${{ env.PUSHED_TAG }} ${{ env.PARACHAIN_NAME }}
          
      - name: 📟 Send Telegram Message
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_T0RN_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            🚀 t0rn Runtime Upgrade ${{ env.PUSHED_TAG }}
            
            Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.PUSHED_TAG }}
            Monitoring: https://monitoring.t3rn.io/d/HyX9GHGVz/chain-statistics?orgId=1&refresh=1m&var-parachain=${{ env.PARACHAIN_NAME }}&var-region=All
            Github Action Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
